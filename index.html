
<!--
Created By: Marco Dagolini
Version: 1.1
Date: 8/7/16
Email: mdagolini@liveperson.com
-->
<!DOCTYPE html>
<html lang="en">
  
  


  
    
    <head>
        <meta charset="utf-8">
        <title>LivePerson LE - CRM Integration</title>
        <script src="https://lpcdn-a.lpsnmedia.net/webagent/client-SDK.min.js"></script>
        <script src="https://apis.google.com/js/api.js"></script>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdn.auth0.com/js/lock/10.2.1/lock.min.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
    
    </head>
    <body>
      
      
      
      
      
      
     <div id="contenitore" style="width:300px; height:200px; background-color:transparent">
         <div id="spessore" style="width:300px; height:10px; background-color:transparent"></div>
         <div id="titolo" style="width:300px; height:50px; background-color:transparent"> <p id="scrittatitolo" align="center" style="color:red">Nel primo paragrafo di questa trattazione, ci occuperemo 
dell'importanza del testo nel Web.</p> </div>
         <div id="dati" style="float:left; width:200px; height:150px; top:10px; right:10px">
 
                <p id="Auth_Name">Name:</p>
                <p id="Auth_Phone">Phone:</p>
                <p id="Auth_Email">Email:</p>
                <p id="Auth_Picture">Picture:</p>
                <p id="Auth_Balance">Balance:</p>
        
   
 
          </div>

      
          <div id="picture" style="background-size: 100%; background-image: url(http://i.imgur.com/AxboLNf.jpg);float:left; width:100px; height:100px; top:10px; left:10px">
          </div>
      </div>
      
     
      
      
      
      
      
      
      
      
      
        <form id="foo" name="foo" style="display:none"> <!-- style="display:block" -->
                <label for="Sender">Sender</label>
                <input id="Sender" name="Sender" type="text" value="" />
                <label for="Message">Message</label>
                <input id="Message" name="Message" type="text" value="" />
                <label for="Name">Name</label>
                <input id="Name" name="Name" type="text" value="" />
                <label for="EMail">EMail</label>
                <input id="EMail" name="EMail" type="text" value="" />
                <label for="Phone">Phone</label>
                <input id="Phone" name="Phone" type="text" value="" />
                <input id="mybtn" type="submit" value="Send" name="mysub" />
            </form>
    
  
        
            <script type="text/javascript">
              
     
              
            $(document).ready(function() {
              
              var SDK=lpTag.agentSDK;
              SDK.init();
              
               var Time = setTimeout(function(){    //gestione IdP
                 
                       var options = {packages: ['corechart'], callback : myCallback};
                       google.load('visualization', '1', options);
                       function callback() {

                       }

                       function myCallback() {

                                setTimeout(function(){ 
                                                      var token = localStorage.getItem('token');
                                                      if (token) {
        
                          
                                                                   var data = JSON.parse(localStorage.getItem('profile'));
                                                                   var identificativo = data.user_id;
                                                                   var String = 'SELECT A, B, C, D, E, F WHERE A=' + "'"+ identificativo + "'";
                                                                   var queryString = encodeURIComponent(String);        
                                                                   var myURL = 'https://docs.google.com/spreadsheets/d/1-bGbupGHbTfYv0aNEchYzU2dvIPTWiYGNaF427AO9oI/gviz/tq?gid=342369015&tq=' + queryString;
                                                                   var query = new google.visualization.Query(myURL);
                                                                   query.send(handleQueryResponse);

                                                                   function handleQueryResponse(response) {
                                                                                                           if (response.isError()) {
                                                                                                                                    alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                                                                                                                                    return;
                                                                                                                                    }

                                                                                                           var data = response.getDataTable();
                                                                                                           var auth_id = data.getValue(0, 0);
                                                                                                           var auth_name = data.getValue(0, 1);
                                                                                                           var auth_phone = data.getValue(0, 2);
                                                                                                           var auth_email = data.getValue(0, 3);
                                                                                                           var auth_picture = data.getValue(0, 4);
                                                                                                           var auth_balance = data.getValue(0, 5);
                                                                                                           document.getElementById("picture").style.backgroundImage = 'url('+ auth_email +')';
                                                                                                           document.getElementById("Auth_Name").innerHTML = auth_name;
                                                                                                           document.getElementById("Auth_Phone").innerHTML = auth_phone;
                                                                                                           document.getElementById("Auth_Email").innerHTML = auth_email;
                                                                                                           document.getElementById("Auth_Balance").innerHTML = auth_balance;
                                                                                                           document.getElementById("scrittatitolo").style.color = "white";
                                                                                                           document.getElementById("scrittatitolo").innerHTML = "Visitatore Autenticato";
                                                                                                           document.getElementById("contenitore").style.backgroundColor = "green";

                                                                                                           }
                                                                    

                                                                    }
                                                                else{
                                                                  
                                                                    }
                                                                     

      

                                                	}, 3000);
                                         }

              
                 
               }, 5000);
              
               var Time = setTimeout(function(){  //gestione CRM
             
                // Variable to hold request
                var request;
                
                // Bind to the submit event of our form
                $("#foo").submit(function(event){
                
                    // Abort any pending request
                    if (request) {
                        request.abort();
                    }
                    // setup some local variables
                    var $form = $(this);
                
                    // Let's select and cache all the fields
                    var $inputs = $form.find("input, select, button, textarea");
                
                    // Serialize the data in the form
                    var serializedData = $form.serialize();
                
                    
                    // Let's disable the inputs for the duration of the Ajax request.
                    // Note: we disable elements AFTER the form data has been serialized.
                    // Disabled form elements will not be serialized.
                    $inputs.prop("disabled", true);
                
                    // Fire off the request to /form.php
                    request = $.ajax({
                        url: "https://script.google.com/macros/s/AKfycbyRgc7YsORM0Wo24Kjto7z_SY7j9cCWUCv4NADAeAAu1Q2p6Yw1/exec",
                        type: "post",
                        data: serializedData
                    });
                
                    // Callback handler that will be called on success
                    request.done(function (response, textStatus, jqXHR){
                        // Log a message to the console
                        console.log("Hooray, it worked!");
                    });
                
                    // Callback handler that will be called on failure
                    request.fail(function (jqXHR, textStatus, errorThrown){
                        // Log the error to the console
                        console.error(
                            "The following error occurred: "+
                            textStatus, errorThrown
                        );
                    });
                
                    // Callback handler that will be called regardless
                    // if the request failed or succeeded
                    request.always(function () {
                        // Reenable the <inputs></inputs>
                        $inputs.prop("disabled", false);
                    });
                
                    // Prevent default posting of form
                    event.preventDefault();
                });
                // var SDK=lpTag.agentSDK;
                // SDK.init();
                // var data={text: "This test worked!"};
                // SDK.command('Write ChatLine',data);
                
              
              
              
     
               
                
                var onSuccess1 = function(data) {
                // Do something with the returning data
                var elem=document.getElementById("Name");
                elem.value=data;
                };
                
                var onError1 = function(data) {
                // Do something with the returning data
                var elem=document.getElementById("Name");
                elem.value="ko";
                };
                
                
                var onSuccess2 = function(data) {
                // Do something with the returning data
                document.getElementById("EMail").value=data;
                };
                
                
                var onError2 = function(data) {
                // Do something with the returning data
                var elem=document.getElementById("EMail");
                elem.value="ko";
                };
                
                var onSuccess3 = function(data) {
                // Do something with the returning data
                document.getElementById("Phone").value=data;
              
                };
            
                var onError3 = function(data) {
                // Do something with the returning data
                var elem=document.getElementById("Phone");
                elem.value="ko";
                };
                
                
                
                
                
                
               
               
             
                SDK.get('surveyQuestions.preChat.name.value', onSuccess1, onError1);
                SDK.get('surveyQuestions.preChat.email.value', onSuccess2, onError2);
                SDK.get('surveyQuestions.preChat.phone.value', onSuccess3, onError3);
               
               
                
                // document.foo.mysub.click();
              
              
             
              
                
                
                // else{
                       // window.location.reload();
                    // }
                 
                  var Time = setTimeout(function(){  
                
                  if (document.getElementById("Name").value) 
                    {
                      document.getElementById("mybtn").click();
                      document.getElementById("Sender").value="";
                      document.getElementById("Message").value="";
                      document.getElementById("Name").value="";
                      document.getElementById("EMail").value="";
                      document.getElementById("Phone").value="";
                    }
              
                   }, 1000);
                 

                 
                 
                }, 5000);
              
                var Time = setTimeout(function(){
                  
                     var isstarted = 0;
               
                     var updateCallback = function(data) {
                       
                       if (isstarted == 0) {
                        
                           document.getElementById("Message").value=data.newValue.lines[0].text;
                           document.getElementById("Sender").value=data.newValue.lines[0].source;
                           document.getElementById("mybtn").click();
                         
                           var firstmessage = setTimeout(function(){
                              document.getElementById("Message").value=data.newValue.lines[1].text;
                              document.getElementById("Sender").value=data.newValue.lines[1].source;
                              document.getElementById("mybtn").click();
                           }, 1000);
                             
                           isstarted = 1;
                         
                       }
                       
                       else {
                       
                          if ((data.newValue.lines[0].text.indexOf('<')> -1) && (data.newValue.lines[0].text.indexOf('>')> -1)) {
                        
                             var inizio = data.newValue.lines[0].text.indexOf('>')+1;
                             var fine = data.newValue.lines[0].text.lastIndexOf('<');
                        
                        
                             document.getElementById("Message").value=data.newValue.lines[0].text.substring(inizio,fine);
                        
                          }
                       
                          else {
                         
                             document.getElementById("Message").value=data.newValue.lines[0].text;
                         
                          }
                       
                          document.getElementById("Sender").value=data.newValue.lines[0].source;
                          document.getElementById("mybtn").click();
                      }
                       
                    };
                  
                    var notifyWhenDone = function(data) {
                        
                    };
       
                  
                    SDK.bind('chatTranscript', updateCallback, notifyWhenDone);
                    
               }, 9000);

              
           });
  
        
      </script>
     
      
     
      
   
      
    </body>
</html>
